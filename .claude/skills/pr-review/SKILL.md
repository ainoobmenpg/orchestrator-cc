---
description: "Review a pull request following the project's review workflow"
argument-hint: "<PR_NUMBER>"
allowed-tools: ["Bash", "Read", "Write", "Edit", "Glob"]
---

# Pull Request レビュー（orchestrator-ccプロジェクト用）

プロジェクトのレビュー運用フローに従ってPRレビューを行います。

**使い方**:
```
/pr-review <PR_NUMBER>
```

PR番号を省略すると、オープン中のPR一覧を表示します。

---

## 実行手順

### ステップ1: プロジェクト設定の読み込み

まず、プロジェクトのレビュー運用フロードキュメントを読み込んでください：

```bash
# ドキュメントの存在確認
ls docs/workflows/pr-review-process.md
```

ドキュメントが存在する場合：
1. `Read: docs/workflows/pr-review-process.md` でレビュー運用フローを読み込む
2. ドキュメントに記載されたチェックリストを適用する

ドキュメントが存在しない場合：
- デフォルトのチェックリストを使用（後述）

### ステップ2: PR情報の取得

引数にPR番号がある場合：

```bash
# PR詳細の取得
gh pr view <PR_NUMBER> --json title,body,author,headRefName,baseRefName,additions,deletions,changedFiles,commits,state,mergedAt,url

# PRのdiffを取得
gh pr diff <PR_NUMBER>
```

引数がない場合：

```bash
# オープン中のPR一覧を表示
gh pr list
```

### ステップ3: 厳格さレベルの判定

PRの変更内容に応じて厳格さレベルを判定してください：

| レベル | 適用対象 | 判断基準 |
|--------|---------|----------|
| **L1: 厳格** | コア機能、リファクタリング | `refactor:`, コアモジュールの変更 |
| **L2: 標準** | 通常の機能追加・バグ修正 | `feat:`, `fix:` |
| **L3: 基礎** | ドキュメント・小さな修正 | `docs:`, 小さなtypo修正 |

### ステップ4: レビュードキュメントの作成

`reviews/pr-XXXX-review.md` を作成してください。

**ディレクトリの作成**:

```bash
# reviewsディレクトリが存在しない場合は作成
mkdir -p reviews
```

**ドキュメントのテンプレート**:

```markdown
# PR #XXXX レビュー: <PRタイトル>

**レビュー日**: <日付>
**レビュアー**: Claude Code
**PR**: <PR URL>
**ブランチ**: <headRefName> → <baseRefName>

---

## レビュー総合評価

**総合判定**: ✅ APPROVE / ⚠️ 要修正 / ❌ 却下

**厳格さレベル**: L1/L2/L3

---

## 要件チェック

### 全レベル共通

- [ ] PR本文と実際の変更内容が一致している
- [ ] PR本文とコミットメッセージが整合している
- [ ] 関連IssueとPR内容が整合している（Issueがある場合）

### L1: 厳格

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが80%以上（または低下していない）
- [ ] 新しい機能にはテストがある
- [ ] 設計が適切
- [ ] セキュリティ上の懸念がない
- [ ] エッジケースが考慮されている
- [ ] パフォーマンス上の問題がない
- [ ] ドキュメントの更新が必要な場合は更新されている

### L2: 標準

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが著しく低下していない
- [ ] 新しい機能にはテストがある
- [ ] バグ修正は正しく修正されている
- [ ] ドキュメントの更新が必要な場合は更新されている

### L3: 基礎

- [ ] mypy型チェックがパスしている（コード変更がある場合）
- [ ] ruffリントチェックがパスしている（コード変更がある場合）
- [ ] ドキュメントの内容が正確
- [ ] 他のドキュメントとの整合性

| 項目 | 結果 | 備考 |
|------|:----:|------|
| mypy型チェック | ✅/❌ | |
| ruffリントチェック | ✅/❌ | |
| テストカバレッジ | ✅/❌ | |
| テスト実行 | ✅/❌ | |

---

## Critical問題

以下のCritical問題が1つでもある場合はLGTMを出さないでください：

- 🔴 型エラーがある
- 🔴 リントエラーがある
- 🔴 テストがない（機能追加の場合）
- 🔴 テストカバレッジが著しく低下している
- 🔴 セキュリティ脆弱性がある
- 🔴 設計が仕様と明らかに異なる
- 🔴 ドキュメントの更新が必要なのに更新されていない
- 🔴 PR本文と実際の変更内容が一致しない
- 🔴 PR本文とコミットメッセージが整合しない

<Critical問題があれば記載、なければ「なし」と記載>

---

## 変更内容のサマリ

### 統計

- 変更ファイル数: <changedFiles>
- 追加行数: <+additions>
- 削除行数: <-deletions>
- コミット数: <commits>

### 新規ファイル

| ファイル | 行数 | 説明 |
|---------|:----:|------|
| <file1> | <lines> | <description> |
| <file2> | <lines> | <description> |

### 変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| <file1> | <description> |
| <file2> | <description> |

---

## 詳細レビュー

### 1. コード構造

- 単一責任の原則に従っているか
- 適切な抽象化・モジュール化
- 再利用性

### 2. バリデーション

- 入力チェックが適切か
- エラー処理が十分か

### 3. 例外処理

- 例外クラスの設計
- 例外チェーン（`from e`）の使用
- エラーメッセージのわかりやすさ

### 4. テスト品質

- 正常系・異常系のカバー
- エッジケースの考慮
- モックの適切な使用

### 5. セキュリティ

- 入力のサニタイズ
- 機密情報の漏洩リスク
- 依存パッケージの安全性

### 6. パフォーマンス

- 不要なループや計算
- メモリ使用量
- 実行時間の懸念

---

## 改善提案

<改善提案があれば記載。優先度（高/中/低）をつける>

| 優先度 | 項目 | 説明 |
|--------|------|------|
| 高/中/低 | <項目> | <説明> |

---

## 完了条件の確認

<関連Issueがある場合、完了条件を記載>

| 完了条件 | 状態 | 説明 |
|---------|:----:|------|
| <条件1> | ✅/❌ | <説明> |
| <条件2> | ✅/❌ | <説明> |

---

## テスト実行結果

```
<テスト実行結果を貼り付け>
```

---

## 結論

<総合評価とマージ推奨可否>

**LGTM（Looks Good To Merge）** / **要修正** / **却下**

<判断の理由を簡潔に記載>

---

## 対応手順

⚠️ **このレビューに対して対応する場合の指示**

ユーザーが「対応」と入力した場合、以下の手順に従ってください：

1. **このレビュードキュメントを先頭から最後まで必ず読んでください**
   - Critical問題の修正が最優先です
   - 改善提案についても確認してください

2. **Critical問題がある場合**
   - まずCritical問題を修正してください
   - 修正が完了したら、必ずテストを実行してください（`make check`）

3. **改善提案について**
   - 優先度が「高」のものは対応を推奨
   - 優先度が「中」「低」のものは、対応しなくても問題ありません
   - 対応する場合は、レビューの指示に従ってください

4. **修正完了後の対応**
   - レビュアーの指示に従ってください（例：「直したらマージ可（再レビュー不要）」）
   - 再レビューが必要な場合は、レビュアーに報告してください

---

**重要**: 「対応」という指示があった場合、必ずこのレビュードキュメントを先頭から最後まで読んでから作業を開始してください。
```

### ステップ5: GitHub PRコメントの投稿

レビュードキュメント作成後、以下の内容でGitHub PRにコメントを投稿してください：

```bash
gh pr comment <PR_NUMBER> --body "<コメント内容>"
```

**GitHub PRコメントのテンプレート**:

```markdown
## レビュー総合評価

**総合判定**: <評価結果>

**厳格さレベル**: L1/L2/L3

---

## 要件チェック

| 項目 | 結果 |
|------|:----:|
| mypy型チェック | ✅/❌ |
| ruffリントチェック | ✅/❌ |
| テストカバレッジ | ✅/❌ |

---

## Critical問題

<なければ「なし」と記載>

---

## 改善提案

<改善提案があれば簡潔に記載>

---

詳細は `reviews/pr-XXXX-review.md` を参照してください。

<承認条件があれば記載。例：「これ直したらマージ可（再レビュー不要）」>
```

---

## 重要: 再レビュー運用

レビュー指摘対応の「再レビュー」は必須ではありません。無限ループを防ぐため、以下の運用を徹底してください。

| 修正内容 | 再レビュー | レビューコメント例 |
|----------|:----------:|-------------------|
| バグ修正 | ⚠️ 任意 | `✅ 直したらマージ可（再レビュー不要）` |
| 小さなtypo修正 | ❌ 不要 | `✅ これ直したらLGTM` |
| Critical問題の修正 | ✅ 推奨 | `📝 直したら再レビュー依頼を` |
| 設計変更 | ✅ 必須 | `📝 設計変更なので再レビューをお願いします` |

最初のレビューで「再レビューの要否」を明確にしてください。

---

## デフォルトチェックリスト

プロジェクトに `docs/workflows/pr-review-process.md` がない場合、以下のデフォルトチェックリストを使用してください：

### 全レベル共通

- [ ] PR本文と実際の変更内容が一致している
- [ ] コミットメッセージが適切

### 品質チェック

- [ ] mypy型チェックがパスしている（コード変更がある場合）
- [ ] ruffリントチェックがパスしている（コード変更がある場合）
- [ ] テストがパスしている
- [ ] 新しい機能にはテストがある
- [ ] 明らかなバグがない

### セキュリティ

- [ ] 入力のサニタイズが適切
- [ ] 機密情報の漏洩リスクがない

---

## 注意事項

- `.gitignore` に `reviews/` が含まれていることを確認してください（レビュードキュメントはコミットされません）
- レビュードキュメントの命名規則: `reviews/pr-XXXX-review.md`
- 再レビューの場合: `reviews/pr-XXXX-review-v2.md`
