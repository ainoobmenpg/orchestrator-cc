<!-- <command-name> -->
review
<!-- </command-name> -->

# Pull Request レビュー（orchestrator-ccプロジェクト用）

このスキルは、orchestrator-ccプロジェクトのレビュー運用フローに従ってPRレビューを行います。

## 使い方

```
/review <Issue番号>
```

Issue番号を省略すると、レビュー待ちのIssue一覧を表示します。

**重要**: このプロジェクトではローカルの`PullRequests/`ディレクトリでレビュー管理を行います。

---

## スキル実行手順

### ステップ1: プロジェクトのレビュー運用フローを読み込む

まず、このプロジェクトのレビュー運用フローを確認してください：

```bash
# プロジェクトルートで実行
Read: docs/workflows/review-process.md
Read: docs/quality/quality-management.md
```

### ステップ2: 既存レビュードキュメントの確認

まず、既存のレビュードキュメントを確認してください：

```bash
# PullRequestsディレクトリのファイル一覧を取得
ls -la PullRequests/

# 以下のパターンでファイルを探索：
# 1. PullRequests/pr-XXXX-review.md
# 2. PullRequests/issue-XXXX-review.md
# 3. PullRequests/pr-XXXX-review-v2.md（再レビュー）
# 4. PullRequests/issue-XXXX-review-v2.md（再レビュー）
```

**ファイルが存在する場合**:
1. ファイルの内容を読み込む（`Read`ツールを使用）
2. 以下の情報をユーザーに表示：
   - 総合判定
   - 要件チェック結果
   - Critical問題
   - 承認条件
3. 新規作成はしない

**ファイルが存在しない場合**:
- ステップ3以降で新規作成を行う

### ステップ3: ブランチ情報の取得

引数にIssue番号がある場合、対応するブランチを特定します：

1. `git branch -a` を実行してブランチ一覧を取得
2. Issue番号に対応するブランチを探す（例: `issue-43`, `task-43` など）
3. `git diff main...<branch> --stat` を実行（変更ファイルの統計）
4. `git log main...<branch> --oneline` を実行（コミット履歴）
5. `git diff main...<branch>` を実行（diffの取得）

引数がない場合：
1. `git branch -a` を実行してレビュー待ちのブランチを表示
2. 特に、`+`マークが付いている最新のブランチを提案

### ステップ4: 厳格さレベルの判定

PRの変更内容に応じて厳格さレベルを判定してください：

| レベル | 適用対象 | 判断基準（例） |
|--------|---------|---------------|
| **L1: 厳格** | コア機能、リファクタリング | `refactor:`, コアモジュールの変更 |
| **L2: 標準** | 通常の機能追加・バグ修正 | `feat:`, `fix:` |
| **L3: 基礎** | ドキュメント・小さな修正 | `docs:`, 小さなtypo修正 |

### ステップ5: 品質チェックの実行

以下のコマンドを実行して品質チェックを行ってください：

```bash
# リントチェック
ruff check <変更ファイル>

# 型チェック
mypy <変更ファイル>

# テスト実行
pytest tests/ -v
```

### ステップ6: レビュードキュメントの作成

**ファイル名の優先順位**:
1. `PullRequests/issue-XXXX-review.md`（Issue番号形式・標準）
2. `PullRequests/pr-XXXX-review.md`（PR番号形式）

Issue番号の場合は `issue-XXXX-review.md` の命名を使用してください。

`PullRequests/issue-XXXX-review.md` を作成してください。テンプレートは以下を使用してください：

```markdown
# PR #XXXX レビュー: <PRタイトル>

**レビュー日**: <日付>
**レビュアー**: Claude Code
**PR**: <PR URL>
**ブランチ**: <ブランチ名>

---

## レビュー総合評価

| 項目 | 結果 |
|------|:----:|
| 総合判定 | ✅ APPROVE（承認） / ⚠️ 要修正 / ❌ 却下 |
| 厳格さレベル | L1/L2/L3 |

---

## 要件チェック

<厳格さレベルに応じたチェックリストを適用>

### 全レベル共通

- [ ] PR本文と実際の変更内容が一致している
- [ ] PR本文とコミットメッセージが整合している
- [ ] 関連IssueとPR内容が整合している（Issueがある場合）

### L1: 厳格（コア機能、リファクタリング）

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが80%以上（または低下していない）
- [ ] 新しい機能にはテストがある
- [ ] 設計が適切（仕様書・既存コードと整合している）
- [ ] セキュリティ上の懸念がない
- [ ] エッジケースが考慮されている
- [ ] パフォーマンス上の問題がない
- [ ] ドキュメントの更新が必要な場合は更新されている

### L2: 標準（通常の機能追加・バグ修正）

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが著しく低下していない
- [ ] 新しい機能にはテストがある
- [ ] バグ修正は正しく修正されている
- [ ] ドキュメントの更新が必要な場合は更新されている

### L3: 基礎（ドキュメント・小さな修正）

- [ ] mypy型チェックがパスしている（コード変更がある場合）
- [ ] ruffリントチェックがパスしている（コード変更がある場合）
- [ ] ドキュメントの内容が正確
- [ ] 他のドキュメントとの整合性

| 項目 | 結果 | 備考 |
|------|:----:|------|
| mypy型チェック | ✅/❌ | |
| ruffリントチェック | ✅/❌ | |
| テストカバレッジ | ✅/❌ | |
| ... | | |

---

## Critical問題

以下のCritical問題が1つでもある場合はLGTMを出さないでください：

- 🔴 型エラーがある
- 🔴 リントエラーがある
- 🔴 テストがない（機能追加の場合）
- 🔴 テストカバレッジが著しく低下している
- 🔴 セキュリティ脆弱性がある
- 🔴 設計が仕様と明らかに異なる
- 🔴 ドキュメントの更新が必要なのに更新されていない
- 🔴 PR本文と実際の変更内容が一致しない
- 🔴 PR本文とコミットメッセージが整合しない

<Critical問題があれば記載、なければ「なし」と記載>

---

## 変更内容

<変更内容の概要>

### 新規ファイル

| ファイル | 行数 | 説明 |
|---------|:----:|------|
| ... | | |

### 変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| ... | ... |

---

## 詳細レビュー

<以下の観点から詳細レビューを実施>

### 1. コード構造

- 単一責任の原則に従っているか
- 適切な抽象化・モジュール化
- 再利用性

### 2. バリデーション

- 入力チェックが適切か
- エラー処理が十分か

### 3. 例外処理

- 例外クラスの設計
- 例外チェーン（`from e`）の使用
- エラーメッセージのわかりやすさ

### 4. テスト品質

- 正常系・異常系のカバー
- エッジケースの考慮
- モックの適切な使用

### 5. セキュリティ

- 入力のサニタイズ
- 機密情報の漏洩リスク
- 依存パッケージの安全性

### 6. パフォーマンス

- 不要なループや計算
- メモリ使用量
- 実行時間の懸念

---

## 改善提案

<改善提案があれば記載。優先度（高/中/低）をつける>

| 優先度 | 項目 | 説明 |
|--------|------|------|
| ... | ... | ... |

---

## テスト実行結果

```
<テスト実行結果を貼り付け>
```

---

## 結論

<総合評価とマージ推奨可否>

**LGTM（Looks Good To Merge）** / **要修正** / **却下**

<判断の理由を簡潔に記載>
```

### ステップ7: レビュー結果の通知

レビュードキュメント作成後、レビュー結果を開発者に通知してください：

**ローカルPR運用の場合**:
- レビュードキュメント `PullRequests/issue-XXXX-review.md` に評価を記録
- 総合判定と承認条件を明記
- Critical問題がある場合は開発者に報告

**GitHub PRがある場合**:
```bash
gh pr comment <PR番号> --body "<コメント内容>"
```

GitHub PRコメントのテンプレート：

```markdown
## レビュー総合評価

総合判定: <評価結果>

## 要件チェック

| 項目 | 結果 |
|------|:----:|
| mypy型チェック | ✅/❌ |
| ruffリントチェック | ✅/❌ |
| テストカバレッジ | ✅/❌ |

## Critical問題

<なければ「なし」と記載>

---

詳細は `PullRequests/issue-XXXX-review.md` を参照してください。

<承認条件があれば記載。例：「これ直したらマージ可（再レビュー不要）」>
```

---

## 重要: 再レビュー運用

レビュー指摘対応の「再レビュー」は必須ではありません。無限ループを防ぐため、以下の運用を徹底してください。

| 修正内容 | 再レビュー | レビューコメント例 |
|----------|:----------:|-------------------|
| バグ修正 | ⚠️ 任意 | `✅ 直したらマージ可（再レビュー不要）` |
| 小さなtypo修正 | ❌ 不要 | `✅ これ直したらLGTM` |
| Critical問題の修正 | ✅ 推奨 | `📝 直したら再レビュー依頼を` |
| 設計変更 | ✅ 必須 | `📝 設計変更なので再レビューをお願いします` |

最初のレビューで「再レビューの要否」を明確にしてください。

---

## 関連ドキュメント

このスキル実行時は、以下のプロジェクトドキュメントを参照してください：

- `docs/workflows/review-process.md` - レビュー運用フロー
- `docs/quality/quality-management.md` - コード品質管理
- `docs/specs/` - 仕様書
