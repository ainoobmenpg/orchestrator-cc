# リスク評価

## リスク一覧

| リスクID | リスク | 影響 | 確率 | 対処 |
|---------|------|------|------|------|
| R-001 | `mcp serve` が対話モードを要求する | 高 | 中 | 対話しない方法を検討 |
| R-002 | `--system-prompt` が機能しない | 中 | 低 | 最初のメッセージでプロンプトを送信 |
| R-003 | 思考ログが出力されない | 低 | 低 | メッセージ内にカスタムフィールドを追加 |
| R-004 | プロセス起動に失敗する | 中 | 低 | リトライ・詳細なログ出力 |
| R-005 | TCP接続が不安定 | 中 | 中 | 再接続ロジック・タイムアウト設定 |
| R-006 | メモリ使用量が大きい | 中 | 中 | プロセス数制限・リソース監視 |
| R-007 | APIコストが増大 | 中 | 高 | キャッシュ・必要な場合のみLLM呼び出し |
| R-008 | 性格プロンプトが守られない | 低 | 中 | プロンプトエンジニアリング |

---

## R-001: `mcp serve` が対話モードを要求する

### 説明

`claude mcp serve` がプログラム制御ではなく、対話的な入力を要求する場合があります。

### 影響

- **影響度**: 🔴 高
- システム全体が機能しなくなる可能性があります

### 発生確率

- **確率**: 🟡 中
- ドキュメントではstdioサポートが明記されていますが、実際の動作は未確認です

### 対処方法

#### 対処1: 別の通信方法を検討

```
【代替案】
- ファイルベースの通信
  • 入力ファイルに書き込む
  • 出力ファイルを読み取る
  • ファイルシステムイベントを監視

【メリット】
- 確実に動作する
- 実装がシンプル

【デメリット】
- リアルタイム性が低い
- ファイルシステムの制約を受ける
```

#### 対処2: 対話モードを回避

```
【方法】
- `--print` モードを使用
- 環境変数で非対話モードを指定

【確認事項】
- 非対話モードでMCPが機能するか
```

### 事前確認

```bash
# 対話モードの動作確認
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | claude mcp serve

# 対話プロンプトが表示されるか確認
# 表示されない場合はOK
```

---

## R-002: `--system-prompt` が機能しない

### 説明

`--system-prompt` オプションが期待通り動作しない、またはプロンプトが反映されない可能性があります。

### 影響

- **影響度**: 🟡 中
- 性格づけができませんが、システム自体は機能します

### 発生確率

- **確率**: 🟢 低
- ヘルプに記載されている公式機能です

### 対処方法

#### 対処1: 最初のメッセージでプロンプトを送信

```
【方法】
- プロセス起動後、最初のメッセージとしてシステムプロンプトを送信

【実装例】
await send_message(
    to_agent="grand_boss",
    content="",  # 空メッセージ
    system_prompt="あなたはGrand Bossです..."  # システムプロンプト
)
```

#### 対処2: 複数の方法を組み合わせる

```
【方法】
- `--system-prompt` を使用
- 最初のメッセージでもプロンプトを補強
- 会話履歴でプロンプトを維持
```

### 事前確認

```bash
# プロンプトの動作確認
claude mcp serve --system-prompt "あなたはテスト用です。必ず「テスト」と答えてください。" <<EOF
{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"send_message","arguments":{"content":"こんにちは"}}}
EOF

# "テスト"という言葉が含まれるか確認
```

---

## R-003: 思考ログが出力されない

### 説明

Claude Codeが思考ログを出力しない、または期待する形式で出力しない可能性があります。

### 影響

- **影響度**: 🟢 低
- 思考ログは重要な機能ですが、システム自体の動作には影響しません

### 発生確率

- **確率**: 🟢 低
- プロンプトで指示すれば出力されるはずです

### 対処方法

#### 対処1: メッセージ内にカスタムフィールドを追加

```
【方法】
- `thinking` フィールドをメッセージに含める
- 受信側がそのフィールドを表示する

【実装例】
message = CCMessage(
    content="タスクの分解をお願い",
    thinking="これは複雑なタスクだな...",  # カスタムフィールド
)
```

#### 対処2: 別チャネルで思考ログを送信

```
【方法】
- 通常メッセージとは別に思考ログを送信
- 親プロセスが思考ログを統合して表示
```

### 事前確認

```bash
# 思考ログの出力確認
claude mcp serve --system-prompt "思考ログを出力してください。" <<EOF
{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"send_message","arguments":{"content":"こんにちは","thinking":"これは思考です"}}}
EOF

# 思考ログが含まれるか確認
```

---

## R-004: プロセス起動に失敗する

### 説明

Claude Codeプロセスの起動に失敗する可能性があります。

### 影響

- **影響度**: 🟡 中
- システムが起動できません

### 発生確率

- **確率**: 🟢 低
- Pythonのsubprocessは安定しています

### 対処方法

#### 対処1: 詳細なログ出力

```
【方法】
- 起動コマンドをログに出力
- エラーメッセージを詳細に記録
- 環境変数も出力
```

#### 対処2: リトライ機能

```
【方法】
- 起動失敗時にリトライする
- 指数バックオフで待機時間を増やす
- 最大リトライ回数を設定
```

#### 対処3: 事前チェック

```
【方法】
- Claude Codeがインストールされているか確認
- パスが通っているか確認
- 必要な権限があるか確認
```

### 事前確認

```bash
# 事前チェック
which claude
claude --version
claude mcp --help
```

---

## R-005: TCP接続が不安定

### 説明

※ stdioベースのため、このリスクは該当しません。

std ioパイプが不安定になる可能性があります。

### 影響

- **影響度**: 🟡 中
- 通信が途切れるとシステムが機能しなくなります

### 発生確率

- **確率**: 🟡 中
- プロセス間通信は一般的に安定していますが、プロセスクラッシュ時は途切れます

### 対処方法

#### 対処1: 再接続ロジック

```
【方法】
- 通信エラーを検出
- 自動的に再接続
- 指数バックオフでリトライ
```

#### 対処2: タイムアウト設定

```
【方法】
- 読み取りタイムアウトを設定
- 書き込みタイムアウトを設定
- 適切な値に調整
```

#### 対処3: ハートビート

```
【方法】
- 定期的にping/pongメッセージを送信
- 生存確認を行う
- 通信の死活を監視
```

### 事前確認

```python
# 通信の安定性テスト
for i in range(1000):
    await send_message(f"メッセージ {i}")
    # エラーが発生しないか確認
```

---

## R-006: メモリ使用量が大きい

### 説明

複数のClaude Codeプロセスを起動するため、メモリ使用量が大きくなる可能性があります。

### 影響

- **影響度**: 🟡 中
- マシンのメモリが不足するとシステムが不安定になります

### 発生確率

- **確率**: 🟡 中
- Claude Codeはそれなりにメモリを使用します

### 対処方法

#### 対処1: プロセス数制限

```
【方法】
- 同時に起動するプロセス数を制限
- 必要なプロセスのみ起動
- 待機中のプロセスを停止
```

#### 対処2: リソース監視

```
【方法】
- メモリ使用量を監視
- しきい値を超えたら警告
- 必要に応じてプロセスを停止
```

#### 対処3: 効率的なメッセージ処理

```
【方法】
- 大きなメッセージを分割
- 不要なデータを破棄
- メモリリークを防止
```

### 事前確認

```bash
# メモリ使用量の確認
claude mcp serve &
PID=$!
ps -o pid,rss,vsz -p $PID
```

---

## R-007: APIコストが増大

### 説明

各Claude Codeインスタンスが独立してLLMを呼び出すため、APIコストが増大します。

### 影響

- **影響度**: 🟡 中
- 運用コストが増加します

### 発生確率

- **確率**: 🔴 高
- 複数インスタンス分のAPIコストがかかります

### 対処方法

#### 対処1: キャッシュ

```
【方法】
- 同じ質問への回答をキャッシュ
- 似たような質問を再利用
- ローカルLLMでの処理を検討
```

#### 対処2: 必要な場合のみLLM呼び出し

```
【方法】
- 単純なメッセージ転送はLLMを使わない
- ルールベースの処理を優先
- LLMは必要な場合のみ使用
```

#### 対処3: 効率的なプロンプト

```
【方法】
- 無駄なプロンプトを削減
- コストを意識した設計
- トークン数を監視
```

### 事前確認

```python
# コスト追跡
from orchestrator.llm import get_cost_tracker

tracker = get_cost_tracker()
stats = tracker.get_stats()

print(f"Total cost: ${stats.total_cost:.4f}")
print(f"Total tokens: {stats.total_tokens}")
```

---

## R-008: 性格プロンプトが守られない

### 説明

システムプロンプトで指定した性格が、実際の動作で反映されない可能性があります。

### 影響

- **影響度**: 🟢 低
- システムの機能には影響しませんが、体験が悪くなります

### 発生確率

- **確率**: 🟡 中
- プロンプトエンジニアリングの難易度によります

### 対処方法

#### 対処1: プロンプトエンジニアリング

```
【方法】
- 具体的な指示を出す
- 例を含める
- 否定的な指示も含める
```

#### 対処2: A/Bテスト

```
【方法】
- 複数のプロンプトを用意
- 効果を測定
- 最適なプロンプトを選択
```

#### 対処3: フィードバックループ

```
【方法】
- 実際の動作を観察
- プロンプトを調整
- 継続的に改善
```

### 事前確認

```bash
# プロンプトのテスト
for prompt in grand_boss_v1.txt grand_boss_v2.txt; do
    echo "Testing $prompt"
    claude mcp serve --system-prompt "$(cat $prompt)" <<EOF
...
EOF
done
```

---

## リスク監視計画

### 定期的監視

| 項目 | 頻度 | 担当 |
|------|------|------|
| APIコスト | 毎日 | 運用チーム |
| メモリ使用量 | 毎時間 | システム |
| エラーログ | リアルタイム | システム |
| プロンプトの効果 | 毎週 | 開発チーム |

### アラート設定

| メトリクス | しきい値 | アクション |
|----------|----------|----------|
| APIコスト/日 | $10 | 警告 |
| メモリ使用率 | 80% | 警告 |
| エラーレート | 5% | 警告 |
| プロセスダウン | 1個以上 | 即座の通知 |
