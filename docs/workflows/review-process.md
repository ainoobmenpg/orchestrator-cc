# レビュー運用フロー

このドキュメントでは、Pull Requestのレビュー運用について詳しく説明します。

---

## 基本原則

🔴 **最優先: レビュー時は必ずハイブリッド方式に従ってください**

**レビューを実施する際は、以下のフローを厳守してください**：

1. **必ず `PullRequests/pr-XXXX-review.md` を作成する**
2. **GitHub PRコメントにはサマリのみを記載する**
3. **GitHub PRコメントでレビュードキュメントへのリンクを貼る**

**または**、`/review <PR番号>` スキルを使用してください。スキルはプロジェクトのレビュー運用フローに従って自動レビューを行います。

---

## レビューの基本フロー

### 1. まずPRの本文を確認する

- 何を変えようとしているのか把握
- 関連Issueを確認
- **PR本文と実際の変更内容が一致しているか確認**
- **PR本文とコミットメッセージが整合しているか確認**

### 2. 変更内容に応じて厳格さレベルを判断

- レベル判断に迷った場合は「厳格寄り（L1）」をデフォルトにする

### 3. レベルに応じたチェックリストを適用

### 4. Critical問題がないか確認

---

## レビューの厳格さレベル

| レベル | 適用対象 | 判断基準（例） |
|--------|---------|---------------|
| **L1: 厳格** | コア機能、リファクタリング | `refactor:`, コアモジュールの変更 |
| **L2: 標準** | 通常の機能追加・バグ修正 | `feat:`, `fix:` |
| **L3: 基礎** | ドキュメント・小さな修正 | `docs:`, 小さなtypo修正 |

---

## レビューチェックリスト（レベル別）

### 全レベル共通

- [ ] PR本文と実際の変更内容が一致している
- [ ] PR本文とコミットメッセージが整合している
- [ ] 関連IssueとPR内容が整合している（Issueがある場合）

### L1: 厳格（コア機能、リファクタリング）

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが80%以上（または低下していない）
- [ ] 新しい機能にはテストがある
- [ ] 設計が適切（仕様書・既存コードと整合している）
- [ ] セキュリティ上の懸念がない
- [ ] エッジケースが考慮されている
- [ ] パフォーマンス上の問題がない
- [ ] ドキュメントの更新が必要な場合は更新されている

### L2: 標準（通常の機能追加・バグ修正）

- [ ] mypy型チェックがパスしている
- [ ] ruffリントチェックがパスしている
- [ ] テストカバレッジが著しく低下していない
- [ ] 新しい機能にはテストがある
- [ ] バグ修正は正しく修正されている
- [ ] ドキュメントの更新が必要な場合は更新されている

### L3: 基礎（ドキュメント・小さな修正）

- [ ] mypy型チェックがパスしている（コード変更がある場合）
- [ ] ruffリントチェックがパスしている（コード変更がある場合）
- [ ] ドキュメントの内容が正確
- [ ] 他のドキュメントとの整合性

---

## Critical問題

**これが1つでもあればLGTMを出さないでください**

- 🔴 型エラーがある
- 🔴 リントエラーがある
- 🔴 テストがない（機能追加の場合）
- 🔴 テストカバレッジが著しく低下している
- 🔴 セキュリティ脆弱性がある
- 🔴 設計が仕様と明らかに異なる
- 🔴 ドキュメントの更新が必要なのに更新されていない
- 🔴 PR本文と実際の変更内容が一致しない
- 🔴 PR本文とコミットメッセージが整合しない

---

## 再レビュー運用

⚠️ **重要**: レビュー指摘対応の「再レビュー」は必須ではありません。無限ループを防ぐため、以下の運用を徹底してください。

### レビューアーの指針

レビューアーは最初のレビューで、**「再レビューの要否」を明確に**してください。

| 修正内容 | 再レビュー | レビューコメント例 |
|----------|:----------:|-------------------|
| バグ修正 | ⚠️ 任意 | `✅ 直したらマージ可（再レビュー不要）` |
| 小さなtypo修正 | ❌ 不要 | `✅ これ直したらLGTM` |
| Critical問題の修正 | ✅ 推奨 | `📝 直したら再レビュー依頼を` |
| 設計変更 | ✅ 必須 | `📝 設計変更なので再レビューをお願いします` |

### 修正者の自己判断

| 修正規模 | 対応 |
|----------|------|
| 小さな修正 | レビューコメントで「修正しました」とコメント → 自己判断でマージOK |
| 大きい修正 | 再レビュー依頼を出す |

### 運用のポイント

1. **最初のレビューで条件を明記**
   - 「これ直したらマージOK（再レビュー不要）」と伝える
   - または「直したら再レビュー依頼を」と明記

2. **修正者は自己判断で**
   - 小さな修正なら「直しました」だけでOK
   - 大きい修正なら再レビュー依頼を出す

3. **GitHubの機能を活用**
   - PRコメントで「LGTM after fixes」としておく
   - 修正が完了したらレビューアーが承認ボタンを押すだけ

### レビュー例

**良い例（再レビュー不要）**:
```markdown
## 指摘
- `pane_index` フィールドが不足しています

## 対応
これを追加したらマージ可（再レビュー不要）
```

**良い例（再レビューあり）**:
```markdown
## 指摘
- データモデルの設計が仕様書と異なります
- 設計変更になるので、修正後に再レビューをお願いします
```

---

## レビュー方式: ローカル完結型

このプロジェクトでは**ローカルレビュードキュメント**のみで完結する方式を採用します。**GitHubへのプッシュは不要です。**

### 方式の概要

| ステップ | 場所 | 内容 |
|----------|------|------|
| 1 | `PullRequests/*.md` | レビュードキュメント（サマリ、Critical問題、承認条件） |
| 2 | `PullRequests/*.md` | 詳細な分析、比較表、推奨修正コード |

**注意**: GitHubへのプッシュは不要。ローカルで完結します。 |

### レビュードキュメントの役割

**PullRequests/*.md**:
- ✅ 詳細な分析
- ✅ 比較表（仕様 vs 実装 vs YAML）
- ✅ 推奨修正コード
- ✅ テスト結果の詳細

### メリット

| メリット | 説明 |
|----------|------|
| ✅ 詳細性 | ドキュメントで詳細に分析できる |
| ✅ 履歴管理 | v1, v2...でレビュー履歴を追跡可能 |
| ✅ ローカル完結 | GitHubへのプッシュ不要 |

### レビュードキュメントの命名規則

```
PullRequests/
├── pr-0001-review.md        # 初回レビュー
├── pr-0001-review-v2.md     # 再レビュー
├── issue-0043-review.md     # Issue番号形式（推奨）
└── issue-0043-review-v2.md  # 再レビュー
```

### レビュー作成コマンド

```bash
# レビュードキュメントを作成
# （レビュアーが手動で作成）
vim PullRequests/pr-XXXX-review.md

# .gitignoreに追加済みなので、レビュードキュメントはコミットされません
```

---

## レビュー対応時の手順

⚠️ **開発者（対応者）向けの指示**

レビューコメントを受けて「対応」する場合、以下の手順に従ってください：

### 1. レビュードキュメントの確認

**必ず `PullRequests/pr-XXXX-review.md` を先頭から最後まで読んでください**。

レビュードキュメントには以下が含まれています：
- Critical問題の修正内容
- 改善提案（優先度付き）
- テスト実行結果
- 承認条件（再レビューの要否）

### 2. Critical問題の修正

Critical問題がある場合は、最優先で修正してください：
- 型エラー
- リントエラー
- テストの欠如
- セキュリティ脆弱性
- その他のCritical問題

### 3. 改善提案への対応

改善提案について確認してください：
- **優先度「高」**: 対応を推奨
- **優先度「中」「低」**: 対応しなくても問題ありません

### 4. テストの実行

修正後は必ずテストを実行してください：

```bash
# 全品質チェック
make check
```

### 5. 修正完了後の対応

レビュアーの指示に従ってください：

| レビュアーの指示 | 対応 |
|----------------|------|
| `直したらマージ可（再レビュー不要）` | 修正完了後、mainブランチにマージしてOK（プッシュ不要） |
| `直したら再レビュー依頼を` | 修正完了後、レビュアーに報告 |
| `これ直したらLGTM` | 小さな修正なら完了報告だけでOK |

---

**重要**: 「対応」という指示があった場合、レビュードキュメントを必ず読んでから作業を開始してください。

---

## 関連ドキュメント

- [../quality/quality-management.md](../quality/quality-management.md) - コード品質管理
- [development-process.md](development-process.md) - 開発ワークフロー
