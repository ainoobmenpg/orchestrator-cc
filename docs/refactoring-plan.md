# orchestrator-cc リファクタリング計画

**作成日:** 2026-02-07
**ステータス:** Draft
**バージョン:** 1.0

---

## 概要

orchestrator-ccプロジェクトのリファクタリング計画。コード品質の向上、技術的負債の解消、保守性の向上を目的とする。

## 現状分析

### プロジェクト規模
- **Pythonファイル:** 1,747ファイル（node_modules含む）
- **主要コード:** 17ファイル（orchestrator/以下）
- **テストファイル:** 30ファイル

### アーキテクチャ
```
orchestrator/
├── core/           # Agent Teams管理、ヘルスモニタリング
├── web/            # FastAPIダッシュボード、WebSocket
├── cli/            # CLIツール
└── agents/         # エージェント関連（現在は空）
```

---

## 課題の特定

### 重要度高（早期対応推奨）

| ID | 課題 | 影響範囲 | 場所 | 複雑度 |
|----|------|----------|------|--------|
| R-001 | `dashboard.py`に重複コードあり | 可読性・保守性 | 行174-177, 125-127 | 小 |
| R-002 | グローバル変数過多（8個） | テスト困難・状態管理 | dashboard.py:33-39 | 中 |

### 重要度中（計画的に対応）

| ID | 課題 | 影響範囲 | 場所 | 複雑度 |
|----|------|----------|------|--------|
| R-003 | TODOコメント未実装（自動再起動ロジック） | 機能未完了 | agent_teams_manager.py:270 | 大 |
| R-004 | `_manager_lock`が使用されない | 不要なコード | agent_teams_manager.py:276 | 小 |

### 重要度低（機会があれば）

| ID | 課題 | 影響範囲 | 場所 | 複雑度 |
|----|------|----------|------|--------|
| R-005 | CORS設定が全許可（`allow_origins=["*"]`） | セキュリティリスク | dashboard.py:118 | 小 |

---

## リファクタリングフェーズ

### Phase 1: クイックウィン（1-2日）

**目標:** 小さい改善で即座に効果を出す

| ID | タイトル | 説明 | 見積もり |
|----|----------|------|----------|
| R-001 | 重複コード削除 | `dashboard.py`のパス設定重複を削除 | 30分 |
| R-004 | 不要なロック変数削除 | `_manager_lock`を削除 | 15分 |
| R-005 | CORS設定の適切化 | 環境変数で制御可能にする | 30分 |

**依存関係:** なし
**リスク:** 低

---

### Phase 2: 構造改善（3-5日）

**目標:** グローバル変数を整理し、テスト容易性を向上

| ID | タイトル | 説明 | 見積もり |
|----|----------|------|----------|
| R-002 | DashboardStateクラス作成 | グローバル変数をクラスにカプセル化 | 2日 |
| R-002-2 | テスト追加 | DashboardStateの単体テスト | 1日 |
| R-002-3 | 既存テスト修正 | グローバル変数参照の修正 | 1日 |

**依存関係:** Phase 1完了後
**リスク:** 中（既存動作への影響）

**対策:**
- 既存テストをすべてパスさせる
- GraphQLでの回帰テストを実施

---

### Phase 3: 機能実装（5-7日）

**目標:** 未実装のTODOを完了

| ID | タイトル | 説明 | 見積もり |
|----|----------|------|----------|
| R-003 | 自動再起動ロジック実装 | エージェントタイムアウト時の自動再起動 | 3日 |
| R-003-2 | 再起動ポリシー設定 | 再起動条件・回数制限などを設定可能に | 1日 |
| R-003-3 | テスト追加 | 自動再起動の統合テスト | 1日 |
| R-003-4 | ドキュメント更新 | 再起動機能のドキュメント作成 | 1日 |

**依存関係:** Phase 2完了後
**リスク:** 高（Agent Teamsの挙動に影響）

**対策:**
- 機能フラグで制御
- 最初はログ出力のみ（ドライラン）
- 段階的に有効化

---

## 実施スケジュール

| 期間 | フェーズ | 主な作業 |
|------|----------|----------|
| Week 1 | Phase 1 | クイックウィン（重複削除、CORS修正） |
| Week 2-3 | Phase 2 | 構造改善（DashboardStateクラス化） |
| Week 4-5 | Phase 3 | 自動再起動ロジック実装 |

---

## 品質目標

- [ ] テストカバレッジ 80%以上維持
- [ ] mypyエラーなし
- [ ] ruff lintエラーなし
- [ ] 既存テスト 100% パス

---

## リスク管理

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| 既存動作の破壊 | 高 | 包括的な回帰テスト実施 |
| Agent Teamsとの互換性 | 中 | Claude Codeのアップデートに追従 |
| テスト環境の不一致 | 中 | Docker等で環境統一検討 |

---

## 成功指標

- [ ] コード行数の削減（目標: -5%）
- [ ] 循環的複雑度の低減
- [ ] テストカバレッジ 80%以上維持
- [ ] 既存機能の回帰なし

---

## 参考文献

- [docs/quality/quality-management.md](quality-management.md)
- [docs/architecture.md](architecture.md)
- [docs/workflows/development-process.md](workflows/development-process.md)
