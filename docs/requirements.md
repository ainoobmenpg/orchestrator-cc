# 要件定義

## 1. 機能要件

### 1.1 Claude Code インスタンスの起動・管理

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-001 | 複数のClaude Codeインスタンスを独立したプロセスとして起動できる | P0 | 未実装 |
| FR-002 | 各インスタンスに役割（Grand Boss, Middle Manager, Specialist）を割り当てられる | P0 | 未実装 |
| FR-003 | 各インスタンスに個別のシステムプロンプト（性格）を設定できる | P0 | 未実装 |
| FR-004 | インスタンスの起動・停止・再起動ができる | P0 | 未実装 |
| FR-005 | インスタンスがクラッシュした場合、自動的に再起動する | P1 | 未実装 |
| FR-006 | インスタンスの状態（実行中・停止中・エラー）を確認できる | P1 | 未実装 |

### 1.2 Claude Code 間の通信

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-101 | Claude Codeインスタンス間でメッセージを送受信できる | P0 | 未実装 |
| FR-102 | メッセージはMCPプロトコル（JSON-RPC 2.0）を使用する | P0 | 未実装 |
| FR-103 | 通信はstdio（標準入出力）経由で行う | P0 | 未実装 |
| FR-104 | 一対一の通信（Point-to-Point）ができる | P0 | 未実装 |
| FR-105 | ブロードキャスト通信（全インスタンスへの送信）ができる | P2 | 未実装 |
| FR-106 | メッセージの配送保証を行う | P1 | 未実装 |
| FR-107 | 通信エラーが発生した場合、再接続を試みる | P1 | 未実装 |

### 1.3 思考ログ

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-201 | 各インスタンスが思考過程を出力できる | P0 | 未実装 |
| FR-202 | 思考ログは詳細レベル（simple/detailed/verbose）を指定できる | P1 | 未実装 |
| FR-203 | 思考ログはメッセージと一緒に送信される | P0 | 未実装 |
| FR-204 | 思考ログはターミナルでリアルタイムに表示される | P0 | 未実装 |
| FR-205 | 思考ログの表示/非表示を切り替えられる | P2 | 未実装 |

### 1.4 性格づけ

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-301 | 各インスタンスに役割に応じた性格を設定できる | P0 | 未実装 |
| FR-302 | 性格はシステムプロンプトとして渡される | P0 | 未実装 |
| FR-303 | 性格プロンプトはファイルから読み込める | P1 | 未実装 |
| FR-304 | 以下の役割の性格定義を提供する | P0 | 未実装 |
| | - Grand Boss: 指示的、大局的、穏やかだが決定力がある | | |
| | - Middle Manager: 調停役、分析的、全体像を意識 | | |
| | - Coding Specialist: 技術的、実務的、正確さを重視 | | |
| | - Research Specialist: 好奇心旺盛、情報収集が得意 | | |
| | - Writing Specialist: 文章力が高い、構成を意識 | | |
| | - Analysis Specialist: 論理的、データドリブン | | |
| | - Testing Specialist: 慎重、境界条件を意識 | | |

### 1.5 会話の観察

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-401 | 各インスタンスの会話をターミナルでリアルタイムに観察できる | P0 | 未実装 |
| FR-402 | 会話には送信メッセージ・受信メッセージ・思考ログが含まれる | P0 | 未実装 |
| FR-403 | 会話はタイムスタンプ付きで表示される | P1 | 未実装 |
| FR-404 | 会話をログファイルに保存できる | P1 | 未実装 |
| FR-405 | 過去の会話ログを閲覧できる | P2 | 未実装 |

### 1.6 ユーザーインターフェース

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-501 | CLIからクラスタを起動・停止できる | P0 | 未実装 |
| FR-502 | CLIからクラスタの状態を確認できる | P1 | 未実装 |
| FR-503 | CLIからユーザー入力をGrand Bossに送れる | P1 | 未実装 |
| FR-504 | 設定はYAMLファイルで行う | P1 | 未実装 |
| FR-505 | Webダッシュボードで会話を観察できる（Phase 4） | P2 | 未実装 |
| FR-506 | Webダッシュボードで思考ログの表示/非表示を切り替えられる（Phase 4） | P2 | 未実装 |

### 1.7 タスク実行

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| FR-601 | Grand Bossがユーザーからタスクを受け付けられる | P0 | 未実装 |
| FR-602 | Middle Managerがタスクを分解してSpecialistsに割り振れる | P0 | 未実装 |
| FR-603 | Specialistが割り当てられたタスクを実行できる | P0 | 未実装 |
| FR-604 | Middle ManagerがSpecialistの結果を集約できる | P0 | 未実装 |
| FR-605 | Grand Bossが最終結果をユーザーに報告できる | P0 | 未実装 |

## 2. 非機能要件

### 2.1 性能

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-101 | メッセージの遅延は1秒以内 | P1 | 未実装 |
| NFR-102 | 思考ログの出力はメッセージ送信から100ms以内 | P2 | 未実装 |
| NFR-103 | システム起動は5秒以内に完了する | P2 | 未実装 |

### 2.2 可用性

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-201 | 単一インスタンスのクラッシュはシステム全体に影響しない | P1 | 未実装 |
| NFR-202 | クラッシュしたインスタンスは自動的に再起動する | P1 | 未実装 |
| NFR-203 | 最大5回まで再起動を試みる | P2 | 未実装 |

### 2.3 拡張性

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-301 | 新しいSpecialistを設定追加のみで追加できる | P1 | 未実装 |
| NFR-302 | 最大10個のインスタンスまで起動できる | P2 | 未実装 |

### 2.4 保守性

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-401 | 既存のorchestratorプロジェクトのコードを最大限再利用する | P1 | 未実装 |
| NFR-402 | コードは型チェック（mypy）に合格する | P2 | 未実装 |
| NFR-403 | コードはリントチェック（ruff）に合格する | P2 | 未実装 |
| NFR-404 | テストカバレッジは80%以上 | P2 | 未実装 |

### 2.5 セキュリティ

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-501 | プロセス間通信はローカルホスト内に限定する | P1 | 未実装 |
| NFR-502 | APIキー等の機密情報は環境変数で管理する | P1 | 未実装 |
| NFR-503 | ログファイルには機密情報を出力しない | P2 | 未実装 |

### 2.6 ユーザビリティ

| 要件ID | 要件 | 優先度 | ステータス |
|--------|------|--------|----------|
| NFR-601 | CLIは直感的に使用できる | P1 | 未実装 |
| NFR-602 | エラーメッセージは明確で具体的である | P1 | 未実装 |
| NFR-603 | ヘルプメッセージを提供する | P2 | 未実装 |

## 3. 制約事項

### 3.1 技術制約

| 制約ID | 制約 | 影響 |
|--------|------|------|
| TC-001 | Claude CodeのMCPサーバー機能に依存する | MCP仕様の変更に影響を受ける |
| TC-002 | 通信はstdio（標準入出力）に限定される | リモート通信には追加実装が必要 |
| TC-003 | Claude Codeのバージョンに依存する | バージョンアップで動作が変わる可能性 |

### 3.2 環境制約

| 制約ID | 制約 | 影響 |
|--------|------|------|
| EC-001 | Python 3.12+ が必要 | 古いバージョンでは動作しない |
| EC-002 | Claude Codeがインストールされている必要がある | 事前のインストールが必要 |
| EC-003 | macOS/Linuxのみサポート | Windows対応には追加作業が必要 |

### 3.3 運用制約

| 制約ID | 制約 | 影響 |
|--------|------|------|
| OC-001 | 各インスタンスがLLM APIを個別に呼び出す | APIコストがインスタンス数比例で増加 |
| OC-002 | 複数プロセスを起動するためメモリ消費が大きい | マシンスペック要件が高くなる |

## 4. 前提条件

### 4.1 システム前提

| 前提ID | 前提 | 確認方法 |
|--------|------|----------|
| SP-001 | Claude Codeがインストールされている | `claude --version` |
| SP-002 | Claude Codeに`mcp serve`コマンドが存在する | `claude mcp serve --help` |
| SP-003 | Claude Codeに`--system-prompt`オプションが存在する | `claude --help` |
| SP-004 | Python 3.12+がインストールされている | `python --version` |

### 4.2 機能前提

| 前提ID | 前提 | 確認方法 |
|--------|------|----------|
| FP-001 | `claude mcp serve`がプログラム制御可能である | 実際にechoでJSON-RPCを送信してテスト |
| FP-002 | `--system-prompt`で性格が設定できる | 異なるプロンプトで動作が変わるか確認 |

## 5. ユースケース

### UC-001: クラスタ起動

| ステップ | 説明 |
|----------|------|
| 1 | ユーザーがCLIで`orchestrator-cc cluster start`を実行 |
| 2 | orchestrator-ccが設定ファイルを読み込む |
| 3 | 各インスタンスを起動 |
| 4 | 全てのインスタンスが起動完了したことを通知 |

### UC-002: タスク実行

| ステップ | 説明 |
|----------|------|
| 1 | ユーザーがタスクを入力 |
| 2 | Grand Bossがタスクを受信 |
| 3 | Grand Bossが思考ログを出力 |
| 4 | Grand BossがMiddle Managerにタスクを送信 |
| 5 | Middle Managerがタスクを分解 |
| 6 | Middle Managerが各Specialistにサブタスクを割り当て |
| 7 | Specialistsがタスクを実行 |
| 8 | Middle Managerが結果を集約 |
| 9 | Grand Bossが最終結果をユーザーに報告 |

### UC-003: 会話の観察

| ステップ | 説明 |
|----------|------|
| 1 | ユーザーがクラスタを起動 |
| 2 | 各インスタンスのターミナルが表示される |
| 3 | インスタンス間のメッセージがリアルタイムで表示される |
| 4 | 思考ログが表示される |
| 5 | ユーザーが会話の流れを観察できる |

## 6. 優先度定義

| 優先度 | 説明 |
|--------|------|
| **P0** | 必須機能。これがないとシステムが成り立たない |
| **P1** | 重要機能。本番運用に必要 |
| **P2** | 希望機能。将来的な実装で良い |
